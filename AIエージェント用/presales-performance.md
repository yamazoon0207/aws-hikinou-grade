# パフォーマンス要件ヒアリング

## 質問項目

### 1. レスポンスタイム
- **質問**: 「ユーザーが許容できる応答時間はどのくらいですか？」
  - API: 100ms以内、500ms以内、1秒以内
  - Webページ: 1秒以内、3秒以内、5秒以内
  - バッチ処理: リアルタイム、数分、数時間

### 2. スループット
- **質問**: 「想定されるトラフィック量は？」
  - 同時接続ユーザー数
  - 1秒あたりのリクエスト数（RPS）
  - 1日あたりのトランザクション数

- **質問**: 「ピーク時のトラフィックは平常時の何倍ですか？」
  - 予測可能なピーク（セール、イベント）
  - 予測不可能なバースト

### 3. データ量
- **質問**: 「扱うデータ量はどのくらいですか？」
  - 初期データ量
  - 月間・年間の増加率
  - 単一ファイル/レコードのサイズ

### 4. 地理的分散
- **質問**: 「ユーザーはどの地域に分散していますか？」
  - 国内のみ
  - アジア太平洋地域
  - グローバル

- **質問**: 「各地域でのレイテンシ要件は？」
  - 100ms以内、200ms以内、500ms以内

## AWSサービスマッピング

### コンピューティング最適化
- **EC2**: インスタンスタイプの選択（C5, M5, R5など）
- **Lambda**: サーバーレス、自動スケーリング
- **ECS/EKS**: コンテナオーケストレーション
- **Fargate**: サーバーレスコンテナ

### データベース最適化
- **RDS**: リードレプリカ、プロビジョンドIOPS
- **Aurora**: 高性能、自動スケーリング
- **DynamoDB**: ミリ秒レイテンシ、オンデマンドキャパシティ
- **ElastiCache**: Redis/Memcached、インメモリキャッシュ

### ネットワーク最適化
- **CloudFront**: CDN、エッジキャッシング
- **Global Accelerator**: グローバルトラフィック最適化
- **VPC**: Enhanced Networking、Placement Groups

### ストレージ最適化
- **S3**: ストレージクラス選択、Transfer Acceleration
- **EBS**: gp3、io2、プロビジョンドIOPS
- **EFS**: スループットモード、パフォーマンスモード

## チェックリスト

- [ ] レスポンスタイム要件の確認
- [ ] トラフィック量の見積もり
- [ ] ピーク時の負荷予測
- [ ] データ量と増加率の確認
- [ ] ユーザー分布の把握
- [ ] レイテンシ要件の確認
- [ ] キャッシュ戦略の検討

## ナレッジ（随時追加）

### 事例・ベストプラクティス
<!-- ここに案件で得た知見を追加してください -->

### パフォーマンステストの観点
<!-- 負荷テスト、ストレステストの知見を追加 -->



---

## 実案件ナレッジ

### 業務処理量

#### 通常時の処理量（インスタンスタイプ・ディスクサイズ決定に影響）

**ユーザー関連:**
- 登録ユーザー数
- 同時アクセスユーザー数
- アクティブユーザー数（DAU/MAU）

**トランザクション量:**
- オンラインリクエスト件数（1日あたり、ピーク時）
- バッチ処理件数（1日あたり）
- API呼び出し回数

**データ量:**
- 初期データ量
- 1日あたりのデータ増加量
- 1ヶ月あたりのデータ増加量
- 単一レコード/ファイルのサイズ

**業務機能:**
- 業務機能数
- 画面数
- バッチジョブ数

#### 増加見込み（将来のスケーリング計画に影響）

**成長予測:**
- 1年後の予測値
- 3年後の予測値
- 5年後の予測値

**増加率:**
- ユーザー数の年間増加率
- データ量の年間増加率
- トランザクション量の増加率

**ピーク予測:**
- 季節変動（繁忙期・閑散期）
- イベント時のピーク（セール、キャンペーン）
- 予測不可能なバースト対応

#### 業務ログ保管期間（ディスクサイズ決定に影響）

**ログ種別と保管期間:**
- アプリケーションログ: 3ヶ月、6ヶ月、1年など
- アクセスログ: 3ヶ月、6ヶ月、1年など
- 監査ログ: 1年、3年、7年など

**ログ容量計算例:**
```
例: Webサーバのログ
- 1日あたり: 0.75 GB
- 1ヶ月あたり: 22.5 GB (0.75 × 30)
- 3ヶ月あたり: 67.5 GB (22.5 × 3)
- 4ヶ月あたり: 90 GB (余裕を持たせた設計)
```

**ログローテーション:**
- ローテーション頻度（日次、週次）
- 圧縮の有無
- アーカイブ先（S3 Glacier等）

### 性能目標値

#### オンライン処理の目標値

**レスポンスタイム:**
- 画面表示: 1秒以内、3秒以内、5秒以内
- API応答: 100ms以内、500ms以内、1秒以内
- 検索処理: 3秒以内、5秒以内、10秒以内
- 帳票生成: 10秒以内、30秒以内、1分以内

**スループット:**
- 1秒あたりのリクエスト数（RPS）
- 1秒あたりのトランザクション数（TPS）
- 同時接続数

**帳票印刷能力:**
- 1分あたりの帳票出力数
- 帳票サイズと出力時間
- 同時印刷可能数

#### バッチ処理の目標値

**バッチレスポンス（ターンアラウンドタイム）:**
- 日次バッチ: 2時間以内、4時間以内など
- 月次バッチ: 8時間以内、12時間以内など
- 処理完了時刻の制約（例: 翌朝8時までに完了）

**バッチスループット:**
- 1時間あたりの処理件数
- 1分あたりの処理件数
- 並列処理数

**バッチウィンドウ:**
- バッチ実行可能時間帯
- 他バッチとの依存関係
- リトライ戦略

### リソース拡張性

#### スケールアップ（垂直スケーリング）

**EC2:**
- インスタンスタイプ変更によるスケールアップ
- 停止が必要（ダウンタイムあり）
- 上限: インスタンスファミリーの最大サイズ

**RDS:**
- インスタンスタイプ変更
- Multi-AZ構成では数分のダウンタイム
- ストレージ拡張（停止不要、オンライン拡張可能）

**EBS:**
- ボリュームサイズの拡張（オンライン拡張可能）
- ボリュームタイプの変更（gp2→gp3等）
- 追加ボリュームのアタッチ

#### スケールアウト（水平スケーリング）

**EC2 Auto Scaling:**
- 自動スケーリングポリシー
- ターゲット追跡スケーリング（CPU使用率等）
- ステップスケーリング
- スケジュールベーススケーリング

**RDS Read Replica:**
- 読み取り負荷の分散
- 最大15個のリードレプリカ
- クロスリージョンレプリカ

**DynamoDB:**
- オンデマンドキャパシティ（自動スケーリング）
- プロビジョンドキャパシティ（手動またはAuto Scaling）

#### ネットワーク拡張性

**VPC:**
- CIDRブロックの追加（最大5個）
- セカンダリCIDRによる拡張
- VPCピアリング、Transit Gatewayによる接続拡張

**帯域幅:**
- Enhanced Networkingの利用
- Placement Groupsの活用
- インスタンスタイプによる帯域幅の違い

### 性能テスト

#### テスト実施要否

**AWS申請が必要なケース:**
- 参考: [Amazon EC2 Testing Policy](https://aws.amazon.com/jp/ec2/testing/)
- 1分を超えて継続する1Gbps（10億ビット/秒）または1Gpps（10億パケット/秒）を超えるテスト
- 不正または悪意があると見られるトラフィックを生成するテスト

**申請不要なケース:**
- 上記条件を満たさない通常の性能テスト
- 社内環境での負荷テスト

#### テスト種別

**負荷テスト:**
- 想定される通常負荷での動作確認
- レスポンスタイムの測定
- リソース使用率の確認

**ストレステスト:**
- 想定を超える負荷での動作確認
- システムの限界値の把握
- ボトルネックの特定

**耐久テスト:**
- 長時間稼働での安定性確認
- メモリリークの検出
- リソース枯渇の確認

**スパイクテスト:**
- 急激な負荷増加への対応確認
- Auto Scalingの動作確認
- キャッシュの効果測定

#### テストツール
- Apache JMeter
- Gatling
- Locust
- AWS Distributed Load Testing（DLT）
- CloudWatch Syntheticsによる継続的監視

### スパイク負荷対応

#### スパイク負荷の定義
- 通常時の負荷と比較して非常に大きな負荷が短時間に発生
- 業務量の想定ピークを超えた状態
- 予測可能なスパイク（セール、イベント）
- 予測不可能なスパイク（バズ、メディア露出）

#### 対応策

**Auto Scaling:**
- ターゲット追跡スケーリング
- ステップスケーリング（段階的なスケールアウト）
- スケジュールベーススケーリング（事前のスケールアウト）
- ウォームアップ時間の設定

**キャッシュ戦略:**
- CloudFront（CDN）によるエッジキャッシュ
- ElastiCache（Redis/Memcached）によるアプリケーションキャッシュ
- API Gatewayのキャッシュ機能
- DynamoDB Accelerator（DAX）

**Sorryページ設定:**
- CloudFrontでのSorryページ配信
- S3静的ホスティングによるSorryページ
- 閾値の設定（CPU 80%超過時など）
- 自動切り替えの仕組み

**スロットリング:**
- API Gatewayのスロットリング設定
- WAFによるレート制限
- アプリケーションレベルでのレート制限

**事前準備:**
- 予測可能なイベント前のスケールアウト
- キャッシュのウォームアップ
- データベースのプロビジョンドIOPS増強
- 監視アラートの強化

#### スパイク対応チェックリスト
- [ ] スパイク負荷の想定（何倍の負荷か）
- [ ] Auto Scalingポリシーの設定
- [ ] キャッシュ戦略の実装
- [ ] Sorryページの準備
- [ ] スロットリング設定
- [ ] 事前スケールアウト計画
- [ ] 監視・アラート設定
- [ ] スパイクテストの実施

### パフォーマンス設計チェックリスト

- [ ] 通常時の業務処理量の確認
- [ ] 増加見込みの確認
- [ ] ログ保管期間とディスク容量の計算
- [ ] オンライン性能目標値の設定
- [ ] バッチ性能目標値の設定
- [ ] スケールアップ戦略の決定
- [ ] スケールアウト戦略の決定
- [ ] 性能テスト計画の策定
- [ ] スパイク負荷対応の設計
- [ ] キャッシュ戦略の決定
- [ ] 監視メトリクスの設定
- [ ] ボトルネックの特定と対策
