[toc]

# Sampleサービス基本設計

Sampleサービスの基本設計を行う

# 構成図

図をはる

# 1. 可用性 
## 継続性
### 運用スケジュール

* 365日24時間？特定日のみ稼働？夜間は停止？など稼働／停止時間について書く
    * 計画停止の有無を書く

### 業務継続範囲

* 社内サービス？外部向けサービス？などサービスの範囲について書く
  * 単一障害／複合障害時にどのサービス継続が必要かを書く

### 目標復旧水準（業務停止時）

* データの損失を許容出来るか否かを書く
  * RTO／RPOについて書く
    * どのサービスをどのくらいの時間でどの時点に戻すか

### 目標復旧水準（大規模災害時）

* データの損失を許容出来るか否かを書く
  * RTO／RPOについて書く
    * どのサービスをどのくらいの時間でどの時点に戻すか

### 稼働率

* 「1年間で数時間程度の停止を許容」など稼働率の要件について書く

## 耐障害性(冗長化の有無)

* EC2／VPC／RDS／EFS／WorkSpaces などの冗長化について書く
   * 図に書くとわかりやすい

## 災害対策(複数AZまたは複数リージョンの利用有無)

* DRサイトの作成有無について書く
  * DRは マルチリージョン or マルチAZ ？ 以下はマルチAZの例
    * サブネット構成はマルチAZとすることにより 障害時には他AZのサブネットにて運用可能とする
    * EC2はマルチAZに配置し利用する
    * マネージドサービス(ELB, FSx, AWS Managed Microsoft AD) は仕様上 複数AZを利用する

## 回復性

* サービスの復旧手段について書く 以下は例
  * EC2基盤障害時には Auto Recovery を利用し 10〜20分程度での回復となる見込み
  * AZ障害時
    * 他AZのサブネットにてバックアップからの復元を行う (60分程度)
    * xxxサーバについては DNS切り替えによる冗長構成により 10〜20分程度での回復となる見込み
    * WEBサーバについては ELBによる冗長構成により 数分程度での回復となる見込み
  * マネージドサービス(ELB, FSx, AWS Managed Microsoft AD)についてはサービスの障害時間となる


# 2. 性能・拡張性
## 業務処理量
### 通常時 (インスタンスタイプなどの選定にも関係あり)

* 以下について書く
  * ユーザ数
  * 同時アクセス数
  * データ量
  * オンラインリクエスト件数
  * バッチ処理件数
  * 業務機能数

### 増加見込み (インスタンスタイプなどの選定にも関係あり)

* 以下の増加見込みについて書く
  * ユーザ数
  * 同時アクセス数
  * データ量
  * オンラインリクエスト件数
  * バッチ処理件数
  * 業務機能数

### 業務ログ保管期間 (ディスクのサイジングにも関係あり)

* 業務ログの保管について書く 例：3ヶ月
    * zz サーバ に蓄積するログ容量としては以下となる
        * 1日あたり 0.75 GB
        * 1ヶ月あたり 22.5 GB
        * 3ヶ月あたり67.5 GB
        *  **4ヶ月あたり 90 GB**

## 性能目標値
### オンライン

* 以下のような項目について目標値があれば記載
  * オンラインレスポンス
  * オンラインスループット

### バッチ

* 以下のような項目について目標値があれば記載
  * バッチレスポンス（ターンアラウンドタイム）
  * バッチスループット
  * 帳票印刷能力

## リソース拡張性

* サービス毎に拡張性を書く
  * EC2/RDS はインスタンスタイプ変更によりスケールアップを行う
  * EBS/RDSのローカルストレージ はボリュームを拡張または増設する
  * VPCは Cidrの追加が可能


## 性能テスト

* 性能テストの実施有無を書く
  *   [Amazon EC2 Testing Policy](https://aws.amazon.com/jp/ec2/testing/) にある以下の条件を満たすかがポイント
    * 「全体として 1 分を越えて継続する、1 Gbps (10 億ビット/秒) または 1 Gpps (10 億パケット/秒) を超えるもの。不正なまたは悪意のあると見られるトラフィックが生成されるもの」

## スパイク負荷対応

* 通常時の負荷と比較して、非常に大きな負荷が短時間に現れ業務量の想定されたピークを超えた状態があるか？について書く
   * Sorryページの設定有無
   * AutoScaling等によるスパイク対応の有無


# 3. 運用・保守性
## 運用時間

* 「24時間365日」「定時内（9時～17時）」など運用監視時間について書く
  * 特定休日等があれば書く

## バックアップ

* EC2、RDSなどの以下について書く
  * バックアップ利用範囲 (障害時のみ、障害時と作業ミス時、など)
  * バックアップ自動化の範囲 (ソフトウェアを用いてスケジュール実行などによる自動化の有無)
  * バックアップ取得間隔 (1日1回など)
  * バックアップ保存期間 (5日分など)
  * バックアップ方式 (オンラインか、停止ありなど)

## 運用監視

* EC2 / RDS
  * CPU
  * メモリ
  * ディスク
  * ネットワーク
  * プロセス
  * アプリログ
  * システムログ
  * 監査ログ
* CloudTrail, AWS Config, Guard Duty

## パッチ適用ポリシー

### 例：EC2
* Systems Manager (以下SSM) または Cloud Automator の機能を用いて各OSにパッチ適用を行う
    * 前提として Cloud Automator には Windows OSのパッチ適用 (WindowsUpdate) 機能があるものの Linux系のパッチ適用 (yum , apt ...etc) 機能は無い
        * 以上より Linux系の パッチ適用については SSMを利用する
        * 例外的にOSコマンドによるパッチ適用も検討する
    * スケジュールやメンテナンスにかける時間等
        * 月1回
        * 5 時間での実施を想定

### 例：RDS
* メンテナンスウインドウを用いてパッチ適用を行う

## 障害時運用(復旧)

* 復旧作業の対応可能時間、担当者、復旧範囲、復旧作業開始までにかかる時間について書く

## 運用環境

* 本番環境の他に開発環境を作るか？について書く
  * 運用環境は本番環境？など
  * 性能試験環境の有無

## 運用マニュアル

* 運用マニュアル の要件について書く 

## リモートオペレーション

* システムの設置環境とは離れた環境からのネットワークを介した監視や操作の可否について書く
   * VPNを経由したアクセスなど

以下は例：
* 各サーバーへのログインの方針は以下とする
    * 秘密鍵やパスワードは踏み台サーバには配置しない
    * Linux系インスタンスにデフォルトで作成している「ec2-user」ユーザー は構築後に削除する
    * root でのログインは不可とする
    * OSユーザーの作成は実際にOSユーザーを利用する組織や人が行う

## 外部システム接続

* システムの運用に影響する外部システムとの接続の有無について書く
   * https接続、 FTP接続など

## サポート体制 (保守契約など)

* サポート窓口等の情報について書く
  * xx とサポート契約を結ぶ など
  * 一次対応 の窓口、導入サポートの窓口など

## ライフサイクル期間

* OSの保守期限切れがいつか？といったシステムのライフサイクル(更改までの期間)について書く

##   定期報告などの必要有無

* システムの運用状態について定期報告するか否かについて書く

# 4. セキュリティ

## 情報セキュリティに関するコンプライアンス

* 順守すべき情報セキュリティに関する組織規程やルール、法令、ガイドライン等が存在するかどうかを書く

## セキュリティリスク分析範囲

* システム開発を実施する中で、どの範囲で対象システムの脅威を洗い出し、影響の分析を実施するかの方針を書く
  * ネットワークを通じた不特定多数の攻撃者からの脅威にさらされるか？
  * 重要情報が取り扱われているか？
  * 運用中の見直し有無

## ネットワーク診断実施の有無

* ネットワーク診断には、目視による設定の確認や、疑似攻撃を実施することにより脆弱性を発見する診断（ペネトレーションテスト）、ネットワーク上のサーバや通信機能をもつソフトウェアなどに対する脆弱性調査等がある
  * 実施するか否かについて書く
  * AWSでの侵入テスト https://aws.amazon.com/jp/security/penetration-testing/

## セキュリティパッチ適用

* 以下を書く
  * 適用対象 (OS,MW,DB)
  * 適用時期 (毎月、毎週)
  * 自動適用の有無 
  * 適用後の確認タイミング

## データ暗号化

* 以下を書く
  * 伝送データの暗号化の有無
  * 蓄積データの暗号化の有無
  * 鍵管理方法

* 伝送データ暗号化の例：インターネットを介する通信(インバウンド・アウトバウンド)をする際には基本的に暗号化を行う
    * ELBやCloudFrontを利用する際には無料でACMの証明書を利用可能であるため利用する
    * その他については購入したTLS証明書や自己証明書を適用し暗号化する
    * 暗号化スイートは適切に選択する (2020年4月現在は TLS 1.2 以上を推奨)


## ログ取得・保管

* 監視用に取得するログの種類・と保管期間を書く
  * AWSの利用状況の監査認証を目的として、AWSが提供する以下の機能を利用することを推奨する
      - AWS CloudTrail
      - AWS Config
      - VPCフローログ


## ネットワーク制御

以下のようなことを書く

### 基本方針
* ファイアウォールには「セキュリティグループ」を用いる
    * 参考リンク: [VPC のセキュリティグループ](https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/VPC_SecurityGroups.html)
* 二重管理となるためNACLやOSのファイアウォール機能は使用しない

### 通信毎の基本方針

**インターネット通信**
* inbound と outboundを制御する
    *  outbound を制御する理由としては組織外のリソースに対する不要なアクセスを予め制限することによりセキュリティを高めるため
* 許可するプロトコルを指定して制御する
* 許可するポート番号を指定して制御する
* 許可するCidrは必要最小限の範囲とする(32bitを推奨)
    * システムの特性上必要な場合は any を許可する
* 通信を許可する必要性がある場合に設定を追加する
    *  管理負荷を考慮し拒否設定は行わない

**VPC内部通信**
* inbound のみ制御する
* 許可するプロトコルを指定して制御する
* 許可するポート番号を指定して制御する
* 許可するCidrは必要最小限の範囲とする
* 通信を許可する必要性がある場合に設定を追加する
    *  管理負荷を考慮し拒否設定は行わない

**比較表**
| | インターネット通信 | VPC内部通信 |
| :-------------------------: | :----------: | :-------------: |
| 制御方向 | inbound , outbound | inbound |
| 制御方法 (許可 or 拒否) | 許可 | 許可 |
| Cidr | 必要最小限の範囲を指定する (32bit推奨) | 必要最小限の範囲を指定する |
| プロトコル | 必要最小限の範囲を指定する | 必要最小限の範囲を指定する |
| ポート番号 | 必要最小限の範囲を指定する | 必要最小限の範囲を指定する |

## マルウェア対策

* マルウェア対策の実施有無を書く

## DDOS対策

* どのように DDSO対策するかを書く
* AWS では、レイヤー 3 およびレイヤー 4 の DDoS 攻撃への対処が自動的に行われる
    *  [DDoS 攻撃への対応](https://docs.aws.amazon.com/ja_jp/waf/latest/developerguide/ddos-responding.html) 
        * ただし 全てのレイヤー 3 およびレイヤー 4 の DDoS 攻撃を防げるとは限らない
*  [AWS Best Practices for DDoS Resiliency](https://d1.awsstatic.com/whitepapers/Security/DDoS_White_Paper.pdf) を踏まえると事前対処としては以下となる
    * CloudFrontなどのCDNを用いてコンテンツをキャッシュしておく
    * WEBサーバとなる EC2 は ELB + AutoScaling を用いてトラフィックの増加に耐えることが可能な仕組みにしておく



