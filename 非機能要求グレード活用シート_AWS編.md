[toc]

# Sampleサービス基本設計

Sampleサービスの基本設計を行う

# 構成図

図をはる

# 可用性 
## 継続性
### 運用スケジュール

* 365日24時間？特定日のみ稼働？夜間は停止？など稼働／停止時間について書く
    * 計画停止の有無を書く

### 業務継続範囲

* 社内サービス？外部向けサービス？などサービスの範囲について書く
  * 単一障害／複合障害時にどのサービス継続が必要かを書く

### 目標復旧水準（業務停止時）

* データの損失を許容出来るか否かを書く
  * RTO／RPOについて書く
    * どのサービスをどのくらいの時間でどの時点に戻すか

### 目標復旧水準（大規模災害時）

* データの損失を許容出来るか否かを書く
  * RTO／RPOについて書く
    * どのサービスをどのくらいの時間でどの時点に戻すか

### 稼働率

* 「1年間で数時間程度の停止を許容」など稼働率の要件について書く

## 耐障害性(冗長化の有無)

* EC2／VPC／RDS／EFS／WorkSpaces などの冗長化について書く
   * 図に書くとわかりやすい

## 災害対策(複数AZまたは複数リージョンの利用有無)

* DRサイトの作成有無について書く
  * DRは マルチリージョン or マルチAZ ？ 以下はマルチAZの例
    * サブネット構成はマルチAZとすることにより 障害時には他AZのサブネットにて運用可能とする
    * EC2はマルチAZに配置し利用する
    * マネージドサービス(ELB, FSx, AWS Managed Microsoft AD) は仕様上 複数AZを利用する

## 回復性

* サービスの復旧手段について書く 以下は例
  * EC2基盤障害時には Auto Recovery を利用し 10〜20分程度での回復となる見込み
  * AZ障害時
    * 他AZのサブネットにてバックアップからの復元を行う (60分程度)
    * xxxサーバについては DNS切り替えによる冗長構成により 10〜20分程度での回復となる見込み
    * WEBサーバについては ELBによる冗長構成により 数分程度での回復となる見込み
  * マネージドサービス(ELB, FSx, AWS Managed Microsoft AD)についてはサービスの障害時間となる

# 性能・拡張性
## 業務処理量
### 通常時 (インスタンスタイプなどの選定にも関係あり)

* 以下について書く
  * ユーザ数
  * 同時アクセス数
  * データ量
  * オンラインリクエスト件数
  * バッチ処理件数
  * 業務機能数

### 増加見込み (インスタンスタイプなどの選定にも関係あり)

* 以下の増加見込みについて書く
  * ユーザ数
  * 同時アクセス数
  * データ量
  * オンラインリクエスト件数
  * バッチ処理件数
  * 業務機能数

### 業務ログ保管期間 (ディスクのサイジングにも関係あり)

* 業務ログの保管について書く 例：3ヶ月
    * zz サーバ に蓄積するログ容量としては以下となる
        * 1日あたり 0.75 GB
        * 1ヶ月あたり 22.5 GB
        * 3ヶ月あたり67.5 GB
        *  **4ヶ月あたり 90 GB**

## 性能目標値
### オンライン

* 以下のような項目について目標値があれば記載
  * オンラインレスポンス
  * オンラインスループット

### バッチ

* 以下のような項目について目標値があれば記載
  * バッチレスポンス（ターンアラウンドタイム）
  * バッチスループット
  * 帳票印刷能力

## リソース拡張性

* サービス毎に拡張性を書く
  * EC2/RDS はインスタンスタイプ変更によりスケールアップを行う
  * EBS/RDSのローカルストレージ はボリュームを拡張または増設する
  * VPCは Cidrの追加が可能


## 性能テスト

* 性能テストの実施有無を書く
  *   [Amazon EC2 Testing Policy](https://aws.amazon.com/jp/ec2/testing/) にある以下の条件を満たすかがポイント
    * 「全体として 1 分を越えて継続する、1 Gbps (10 億ビット/秒) または 1 Gpps (10 億パケット/秒) を超えるもの。不正なまたは悪意のあると見られるトラフィックが生成されるもの」

## スパイク負荷対応

* 通常時の負荷と比較して、非常に大きな負荷が短時間に現れ業務量の想定されたピークを超えた状態があるか？について書く
   * Sorryページの設定有無
   * AutoScaling等によるスパイク対応の有無


# 運用・保守性
## 運用時間

* 「24時間365日」「定時内（9時～17時）」など運用監視時間について書く
  * 特定休日等があれば書く

## バックアップ

* EC2、RDSなどの以下について書く
  * バックアップ利用範囲 (障害時のみ、障害時と作業ミス時、など)
  * バックアップ自動化の範囲 (ソフトウェアを用いてスケジュール実行などによる自動化の有無)
  * バックアップ取得間隔 (1日1回など)
  * バックアップ保存期間 (5日分など)
  * バックアップ方式 (オンラインか、停止ありなど)

## 運用監視

* EC2 / RDS
  * CPU
  * メモリ
  * ディスク
  * ネットワーク
  * プロセス
  * アプリログ
  * システムログ
  * 監査ログ
* CloudTrail, AWS Config, Guard Duty

## パッチ適用ポリシー

### 例：EC2
* Systems Manager (以下SSM) または Cloud Automator の機能を用いて各OSにパッチ適用を行う
    * 前提として Cloud Automator には Windows OSのパッチ適用 (WindowsUpdate) 機能があるものの Linux系のパッチ適用 (yum , apt ...etc) 機能は無い
        * 以上より Linux系の パッチ適用については SSMを利用する
        * 例外的にOSコマンドによるパッチ適用も検討する
    * スケジュールやメンテナンスにかける時間等
        * 月1回
        * 5 時間での実施を想定

### 例：RDS
* メンテナンスウインドウを用いてパッチ適用を行う

## 障害時運用(復旧)

* 復旧作業の対応可能時間、担当者、復旧範囲、復旧作業開始までにかかる時間について書く

## 運用環境

* 本番環境の

## サポート体制 (保守契約など)

* 代行サービスを利用する

# セキュリティ

## ログ保管

* AWSの利用状況の監査認証を目的として、AWSが提供する以下の機能を利用することを推奨する
    - AWS CloudTrail
    - AWS Config
    - VPCフローログ
        - 詳細については  [[監査認証]]  を参照のこと

* AWS上の操作ログ（CloudTrail・Config・GuardDuty）は中央アカウントに集約し、分析を容易にする
* その他のログは各システムごとのアカウントに出力し保管する

| 　対象ログ種別　   |   要否  |      形式       |            保管先              | 保管期間 |
| :-------------------------: | :----------: | :-------------: | :---------------------------: | ---------------------------- |
| EC2（OSやM/W） | 任意  **※1**   | CloudWatch Logs |         自アカウント          |          |
|             RDS             |     必須     | CloudWatch Logs |         自アカウント          |                              |
|        VPC Flow log         |     必須     | CloudWatch Logs |         自アカウント          |                              |
|      ELB アクセスログ       |     必須     | CloudWatch Logs |         自アカウント          |                              |
|       Lambda実行ログ        |     必須     | CloudWatch Logs |         自アカウント          |                              |
|          WAF ログ           |     任意     | CloudWatch Logs |         自アカウント          |                              |
|         CloudTrail          |     必須     | CloudWatch Logs / S3 オブジェクト | 自アカウント / 中央 |                          |
|           Config            |     必須     | CloudWatch Logs / S3 オブジェクト | 自アカウント / 中央 |                              |
|          GuardDuty          |     必須     | CloudWatch Logs / S3 オブジェクト | 自アカウント / 中央 |                              |


## ネットワークフィルタリング設計
### 基本方針
* ファイアウォールには「セキュリティグループ」を用いる
    * 参考リンク: [VPC のセキュリティグループ](https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/VPC_SecurityGroups.html)
* 二重管理となるためNACLやOSのファイアウォール機能は使用しない

### 通信毎の基本方針

** インターネット通信 **
* inbound と outboundを制御する
    *  outbound を制御する理由としては組織外のリソースに対する不要なアクセスを予め制限することによりセキュリティを高めるため
* 許可するプロトコルを指定して制御する
* 許可するポート番号を指定して制御する
* 許可するCidrは必要最小限の範囲とする(32bitを推奨)
    * システムの特性上必要な場合は any を許可する
* 通信を許可する必要性がある場合に設定を追加する
    *  管理負荷を考慮し拒否設定は行わない

** VPC内部通信 **
* inbound のみ制御する
* 許可するプロトコルを指定して制御する
* 許可するポート番号を指定して制御する
* 許可するCidrは必要最小限の範囲とする
* 通信を許可する必要性がある場合に設定を追加する
    *  管理負荷を考慮し拒否設定は行わない

** 比較表 **
| | インターネット通信 | VPC内部通信 |
| :-------------------------: | :----------: | :-------------: |
| 制御方向 | inbound , outbound | inbound |
| 制御方法 (許可 or 拒否) | 許可 | 許可 |
| Cidr | 必要最小限の範囲を指定する (32bit推奨) | 必要最小限の範囲を指定する |
| プロトコル | 必要最小限の範囲を指定する | 必要最小限の範囲を指定する |
| ポート番号 | 必要最小限の範囲を指定する | 必要最小限の範囲を指定する |


## 内部脅威対策

* 各サーバーへのログインの方針は以下とする
    * 秘密鍵やパスワードは踏み台サーバには配置しない
    * Linux系インスタンスにデフォルトで作成している「ec2-user」ユーザー は構築後に削除する
    * root でのログインは不可とする
    * OSユーザーの作成は実際にOSユーザーを利用する組織や人が行う

## 外部脅威対策

|  対策  |  レイヤ  | 対策が必要なAWSサービス | 対策の概要 |
| :---- | :---- | :---- | :---- | :---- |
| ウイルス対策 | OS | EC2 | アンチウイルスソフトをEC2インスタンス上のOSにインストールすることで対策を実施する |
| 不正アクセス対策 | ネットワーク | VPC | セキュリティグループを用いてinboundパケットとoutboundパケットをポート毎に制御する |
| 不正アクセス対策 | ネットワーク | EC2 | OSファイアウォールは使用せずに セキュリティグループを用いてinboundパケットとoutboundパケットをポート毎に制御する |
| 不正アクセス対策 | ネットワーク | ELB | セキュリティグループを用いてinboundパケットとoutboundパケットをポート毎に制御する |
| 不正アクセス対策 | ネットワーク | RDS | セキュリティグループを用いてinboundパケットとoutboundパケットをポート毎に制御する |
| 不正アクセス対策 | OS | EC2  | セキュリティ対策ソフト(DSaaS)のセキュリティログ監視機能に相当するもので不正アクセスの検知・対策を行う |
| 改ざん対策 | OS | EC2 | セキュリティ対策ソフト(DSaaS)のファイル変更監視機能に相当するもので改ざんの検知・対策を行う |
| 脆弱性対策 | OS | EC2 | セキュリティ対策ソフト(DSaaS)の脆弱性対策機能（仮想パッチ機能）に相当するもので脆弱性対策を行う |
| 脆弱性対策 | OS | EC2 | 上記に関わらず、利用中OSからセキュリティパッチが配布された場合、緊急度合いに応じてパッチ適用を実施し脆弱性対策を行う |
| 脆弱性対策 | ミドルウェア | EC2 | セキュリティ対策ソフト(DSaaS)の脆弱性対策機能（仮想パッチ機能）に相当するもので脆弱性対策を行う |
| 脆弱性対策 | ミドルウェア | RDS | AWSから利用サービスのパッチが配布された場合に適用し脆弱性対策を行う |
| 脆弱性対策 | コンテンツ | EC2 | アプリケーションの脆弱性診断は本番環境デプロイ前に実施されるものとする |

## 暗号化方針

* インターネットを介する通信(インバウンド・アウトバウンド)をする際には基本的に暗号化を行う
    * ELBやCloudFrontを利用する際には無料でACMの証明書を利用可能であるため利用する
    * その他については購入したTLS証明書や自己証明書を適用し暗号化する
    * 暗号化スイートは適切に選択する (2020年4月現在は TLS 1.2 以上を推奨)

## DDOS対策

### 前提
* AWS では、レイヤー 3 およびレイヤー 4 の DDoS 攻撃への対処が自動的に行われる
    *  [DDoS 攻撃への対応](https://docs.aws.amazon.com/ja_jp/waf/latest/developerguide/ddos-responding.html) 
        * ただし 全てのレイヤー 3 およびレイヤー 4 の DDoS 攻撃を防げるとは限らない

*  [AWS Best Practices for DDoS Resiliency](https://d1.awsstatic.com/whitepapers/Security/DDoS_White_Paper.pdf) を踏まえると事前対処としては以下となる
    * CloudFrontなどのCDNを用いてコンテンツをキャッシュしておく
    * WEBサーバとなる EC2 は ELB + AutoScaling を用いてトラフィックの増加に耐えることが可能な仕組みにしておく

### 方針
* 基本的には各サービスのシステム要件(DDOS対策の要不要、キャッシュの可不可、AutoScalingの可不可)によって方針を決めることとする


